# Subagent Report: Task T02 — Design caching strategy

**Track:** demo-add-caching
**Task ID:** T02
**Role:** Architect
**Completed:** 2026-01-17 13:45
**Status:** Complete
**Effort:** 1.5 hours (estimated: 2 hours)

---

## Summary (What Was Done)

Designed comprehensive caching strategy for AstroVisor API based on T01 performance analysis. Created ADR document and defined cache key patterns.

**Key deliverables:**
- ADR-005: Caching Strategy for API Endpoints
- Cache key schema definition
- Invalidation strategy document

**Acceptance criteria status:**
- [x] ADR approved (user confirmed Redis over Memcached)
- [x] Cache keys defined for natal and transits endpoints
- [x] Invalidation patterns documented

---

## Decisions Made

### Decision 1: Use Redis for caching

**Context:** Need distributed cache for API layer.

**Options considered:**
1. **Redis (chosen):**
   - Pros: Rich data structures, TTL support, pub/sub for invalidation
   - Cons: Additional infrastructure
2. **Memcached:**
   - Pros: Simple, fast
   - Cons: No data structures, manual invalidation
3. **In-process cache:**
   - Pros: No network overhead
   - Cons: Not shared across instances

**Decision:** Redis — better invalidation support and data structures for complex responses.

**User input:** Confirmed Redis (foreground question resolved)

**ADR:** `docs/caching-adr.md`

---

## Files Touched

### Touches Planned (from brief)
```
docs/caching-adr.md
```

### Touches Actual (observed) — v1.1.1 CRITICAL
```
docs/caching-adr.md
docs/cache-keys.md (NEW - unplanned)
```

**Lock Manager Alert:** Unplanned touch on `docs/cache-keys.md`

### Created
- `docs/caching-adr.md` - Architecture Decision Record for caching strategy
- `docs/cache-keys.md` - Cache key schema documentation (unplanned but necessary)

### Unplanned Touches (if any)
- `docs/cache-keys.md` - Needed separate doc for cache key patterns
  - **Risk:** low — docs folder, no code conflicts
  - **Resolution:** Created SpawnCandidate for review

### Total impact
- Files created: 2
- Files modified: 0
- Files deleted: 0
- Unplanned touches: 1 (low risk)
- Total lines changed: ~120

---

## IOSM Quality Gate Results

### Gate-I (Improve)
- [x] Clear naming in ADR
- [x] No magic values (TTLs as named constants)
- **Score:** 0.90 / 1.0

### Gate-M (Modularize)
- [x] Clear cache contract defined
- [x] Interface documented
- **Score:** 0.95 / 1.0

---

## SpawnCandidates (v1.1.1 — MANDATORY)

| ID | Subtask | Touches | Effort | User Input | Severity | Dedup Key | Accept Criteria |
|----|---------|---------|--------|------------|----------|-----------|-----------------|
| SC-02 | Fix 2 failing cache tests | `tests/test_natal.py`, `tests/test_transits.py` | S | false | high | `test_natal.py|fix-test` | All tests pass |

### SpawnCandidates Summary

- **Auto-spawn eligible:** 1
- **Needs user decision:** 0
- **Critical:** 0

### Notes for Orchestrator

SC-02 anticipated — when T04/T05 implement caching, existing tests will need updates for cache behavior.

---

## Escalation Requests (v1.1)

None.

---

## Handoff Notes to Integrator

### Integration Instructions
1. ADR should be reviewed before T03 starts implementation
2. Cache key schema in `docs/cache-keys.md` is source of truth

### Cache Key Schema

```python
# Natal endpoint
CACHE_KEY_NATAL = "natal:{user_id}:{birth_date}:{location_hash}"
CACHE_TTL_NATAL = 3600  # 1 hour

# Transits endpoint
CACHE_KEY_TRANSITS = "transits:{user_id}:{date}:{location_hash}"
CACHE_TTL_TRANSITS = 300  # 5 minutes (time-sensitive)
```

### Dependencies
- **Blocks T03:** Implementer needs cache key schema
- **Blocks T04, T05:** Need cache service from T03

---

**Report completed by:** Architect subagent
**Next step:** T03 (Implementer builds cache service)
